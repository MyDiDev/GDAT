<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Transaction Fraud Detector | GDAT</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr"
      crossorigin="anonymous"
    />
    <link
      rel="icon"
      type="png"
      href="https://exafunction.github.io/public/brand/windsurf-white-symbol.png"
    />
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/2.3.2/css/dataTables.bootstrap5.css"
    />
    <link rel="stylesheet" href="../ui.css" />
  </head>
  <body>
    <div class="d-flex gap-2 h-100 w-100">
      <div class="position-sticky top-0">
        <aside id="sideBar" class="bg-body-tertiary">
          <div class="p-3 d-flex justify-content-center align-items-center">
            <img
              src="https://exafunction.github.io/public/brand/windsurf-white-symbol.png"
              alt="icon"
              class="img-fluid rounded-sm"
              width="60px"
              height="60px"
            />
          </div>
          <div class="d-flex flex-column mt-2">
            <a href="/home" class="btn btn-primary rounded-0 p-3 fw-bold fs-5"
              >Home</a
            >
            <a
              href="/forms/deposit"
              class="btn btn-dark rounded-0 p-3 fw-bold fs-5"
              >Deposit</a
            >
            <a
              href="/forms/withdraw"
              class="btn btn-dark rounded-0 p-3 fw-bold fs-5"
              >Withdraw</a
            >
            <a
              href="/user/profile"
              class="btn btn-dark rounded-0 p-3 fw-bold fs-5"
              >Profile</a
            >
          </div>
        </aside>
      </div>

      <div class="container-fluid d-flex flex-column gap-3 h-100 mt-3">
        <div class="mb-1 mt-3">
          <h1 class="mb-3">Welcome <%= user.name %>!</h1>
          <div class="form-floating">
            <select id="periodDays" class="form-control bg-body-tertiary">
              <option value="7">7 Days</option>
              <option value="30">1 Month</option>
              <option value="180">6 Months</option>
              <option value="365">1 Year</option>
              <option value="<% new Date().getFullYear() * 365 %>">
                All Time
              </option>
            </select>
            <label for="periodDays">Period of Time</label>
          </div>
        </div>
        <div class="row">
          <div class="col-12 col-md-6 col-lg-3 mb-1">
            <div class="bg-body-tertiary p-2 rounded shadow border">
              <p class="mb-2 fs-5">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="20"
                  height="20"
                  fill="lightGreen"
                  class="bi bi-currency-dollar"
                  viewBox="0 0 16 16"
                >
                  <path
                    d="M4 10.781c.148 1.667 1.513 2.85 3.591 3.003V15h1.043v-1.216c2.27-.179 3.678-1.438 3.678-3.3 0-1.59-.947-2.51-2.956-3.028l-.722-.187V3.467c1.122.11 1.879.714 2.07 1.616h1.47c-.166-1.6-1.54-2.748-3.54-2.875V1H7.591v1.233c-1.939.23-3.27 1.472-3.27 3.156 0 1.454.966 2.483 2.661 2.917l.61.162v4.031c-1.149-.17-1.94-.8-2.131-1.718zm3.391-3.836c-1.043-.263-1.6-.825-1.6-1.616 0-.944.704-1.641 1.8-1.828v3.495l-.2-.05zm1.591 1.872c1.287.323 1.852.859 1.852 1.769 0 1.097-.826 1.828-2.2 1.939V8.73z"
                  />
                </svg>
                Current Balance:
              </p>
              <h4 class="fw-bold">$<%= data[0][0][0].current_balance %></h4>
            </div>
          </div>
          <div class="col-12 col-md-6 col-lg-3 mb-1">
            <div class="bg-body-tertiary p-2 rounded shadow border">
              <p class="mb-2 fs-5">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="20"
                  height="20"
                  fill="lightBlue"
                  class="bi bi-wallet-fill"
                  viewBox="0 0 16 16"
                >
                  <path
                    d="M1.5 2A1.5 1.5 0 0 0 0 3.5v2h6a.5.5 0 0 1 .5.5c0 .253.08.644.306.958.207.288.557.542 1.194.542s.987-.254 1.194-.542C9.42 6.644 9.5 6.253 9.5 6a.5.5 0 0 1 .5-.5h6v-2A1.5 1.5 0 0 0 14.5 2z"
                  />
                  <path
                    d="M16 6.5h-5.551a2.7 2.7 0 0 1-.443 1.042C9.613 8.088 8.963 8.5 8 8.5s-1.613-.412-2.006-.958A2.7 2.7 0 0 1 5.551 6.5H0v6A1.5 1.5 0 0 0 1.5 14h13a1.5 1.5 0 0 0 1.5-1.5z"
                  />
                </svg>
                Total Transactions:
              </p>
              <h4 class="fw-bold" id="totalTransactions"><%= data[0][0][0].total_transactions %></h4>
            </div>
          </div>
          <div class="col-12 col-md-6 col-lg-3 mb-1">
            <div class="bg-body-tertiary p-2 rounded shadow border">
              <p class="mb-2 fs-5">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="20"
                  height="20"
                  fill="green"
                  class="bi bi-piggy-bank-fill"
                  viewBox="0 0 16 16"
                >
                  <path
                    d="M7.964 1.527c-2.977 0-5.571 1.704-6.32 4.125h-.55A1 1 0 0 0 .11 6.824l.254 1.46a1.5 1.5 0 0 0 1.478 1.243h.263c.3.513.688.978 1.145 1.382l-.729 2.477a.5.5 0 0 0 .48.641h2a.5.5 0 0 0 .471-.332l.482-1.351c.635.173 1.31.267 2.011.267.707 0 1.388-.095 2.028-.272l.543 1.372a.5.5 0 0 0 .465.316h2a.5.5 0 0 0 .478-.645l-.761-2.506C13.81 9.895 14.5 8.559 14.5 7.069q0-.218-.02-.431c.261-.11.508-.266.705-.444.315.306.815.306.815-.417 0 .223-.5.223-.461-.026a1 1 0 0 0 .09-.255.7.7 0 0 0-.202-.645.58.58 0 0 0-.707-.098.74.74 0 0 0-.375.562c-.024.243.082.48.32.654a2 2 0 0 1-.259.153c-.534-2.664-3.284-4.595-6.442-4.595m7.173 3.876a.6.6 0 0 1-.098.21l-.044-.025c-.146-.09-.157-.175-.152-.223a.24.24 0 0 1 .117-.173c.049-.027.08-.021.113.012a.2.2 0 0 1 .064.199m-8.999-.65a.5.5 0 1 1-.276-.96A7.6 7.6 0 0 1 7.964 3.5c.763 0 1.497.11 2.18.315a.5.5 0 1 1-.287.958A6.6 6.6 0 0 0 7.964 4.5c-.64 0-1.255.09-1.826.254ZM5 6.25a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0"
                  />
                </svg>
                Total Income:
              </p>
              <h4 class="fw-bold">$<%= data[0][0][0].total_income %></h4>
            </div>
          </div>
          <div class="col-12 col-md-6 col-lg-3 mb-1">
            <div class="bg-body-tertiary p-2 rounded shadow border">
              <p class="mb-2 fs-5">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="20"
                  height="20"
                  fill="gold"
                  class="bi bi-currency-exchange"
                  viewBox="0 0 16 16"
                >
                  <path
                    d="M0 5a5 5 0 0 0 4.027 4.905 6.5 6.5 0 0 1 .544-2.073C3.695 7.536 3.132 6.864 3 5.91h-.5v-.426h.466V5.05q-.001-.07.004-.135H2.5v-.427h.511C3.236 3.24 4.213 2.5 5.681 2.5c.316 0 .59.031.819.085v.733a3.5 3.5 0 0 0-.815-.082c-.919 0-1.538.466-1.734 1.252h1.917v.427h-1.98q-.004.07-.003.147v.422h1.983v.427H3.93c.118.602.468 1.03 1.005 1.229a6.5 6.5 0 0 1 4.97-3.113A5.002 5.002 0 0 0 0 5m16 5.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0m-7.75 1.322c.069.835.746 1.485 1.964 1.562V14h.54v-.62c1.259-.086 1.996-.74 1.996-1.69 0-.865-.563-1.31-1.57-1.54l-.426-.1V8.374c.54.06.884.347.966.745h.948c-.07-.804-.779-1.433-1.914-1.502V7h-.54v.629c-1.076.103-1.808.732-1.808 1.622 0 .787.544 1.288 1.45 1.493l.358.085v1.78c-.554-.08-.92-.376-1.003-.787zm1.96-1.895c-.532-.12-.82-.364-.82-.732 0-.41.311-.719.824-.809v1.54h-.005zm.622 1.044c.645.145.943.38.943.796 0 .474-.37.8-1.02.86v-1.674z"
                  />
                </svg>
                Total Expenses:
              </p>
              <h4 class="fw-bold">$<%= data[0][0][0].total_expenses %></h4>
            </div>
          </div>
        </div>
        <div class="row gap-1">
          <input type="hidden" id="dashboardData" value="<%= data %>" />
          <div class="col">
            <div class="bg-body-tertiary p-2 rounded-sm shadow h-100 border">
              <% const transactions = data["1"] && data["1"][0] && !data[1][0][0].result ? data["1"][0] :
              []; %>
              <div class="p-2 rounded-sm shadow h-100">
                <% if (transactions.length > 0) { %>
                <table class="table table-striped table-hover" id="table">
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th>Account ID</th>
                      <th>Description</th>
                      <th>Amount</th>
                      <th>State</th>
                      <th>Category</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% transactions.forEach(transaction => { %>
                    <tr>
                      <% Object.values(transaction).forEach(value => { %>
                      <td><%= value %></td>
                      <% }) %>
                    </tr>
                    <% }) %>
                  </tbody>
                </table>
                <% } else { %>
                <p>No transactions registered.</p>
                <% } %>
            </div>
          </div>
        </div>
        <div class="row h-100 mt-3">
          <div class="col-md-6 h-100">
            <div class="p-2 rounded-sm shadow h-100 bg-body-tertiary border">
              <h5 class="p-2">Categories Spent</h5>
              <canvas id="categoryChart"></canvas>
            </div>
          </div>
          <div class="col-md-6 d-flex flex-column h-100">
            <div class="flex-fill mb-3">
              <div class="p-2 rounded-sm shadow h-100 bg-body-tertiary border">
                <h5 class="p-2">Transactions Realized</h5>
                <canvas id="transactionsChart"></canvas>
              </div>
            </div>

            <div class="flex-fill">
              <div class="p-2 rounded-sm shadow h-100 bg-body-tertiary border">
                <h5 class="p-2">Transactions Realized</h5>
                <canvas id="transactionsChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
    <script src="https://cdn.datatables.net/2.3.2/js/dataTables.js"></script>
    <script src="https://cdn.datatables.net/2.3.2/js/dataTables.bootstrap5.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q"
      crossorigin="anonymous"
    ></script>
    <script>
      const $ = (id) => document.getElementById(id);

      const token = <%- JSON.stringify(token).toString() %>;
      const dashboardData = <%- JSON.stringify(data) %>;
      const transactionCategories = {
        Deposit: 0,
        Withdraw: 0
      };
      const transactionAmounts = [];
      const transactionDates = [];
      const transactionsRegistered = dashboardData[1][0];
      
      if(transactionsRegistered && transactionsRegistered.length > 0){
        transactionsRegistered.forEach(transaction => {
          if (transaction.transaction_type == "Deposit")
            transactionCategories.Deposit += transaction.amount;
          else if (transaction.transaction_type == "Withdraw")
            transactionCategories.Withdraw += transaction.amount;
          transactionAmounts.push(transaction.amount);
          transactionDates.push(transaction.transaction_date);
        });
      }

      new DataTable("#table");
      new Chart($("transactionsChart"), {
        type: "line",
        data: {
          labels: transactionDates,
          datasets: [
            {
              label: "# of Transactions",
              data: transactionAmounts,
              borderWidth: 1,
            },
          ],
        },
        options: {
          scales: {
            y: {
              betinAtZero: true,
            },
          },
        },
      });
      new Chart($("categoryChart"), {
        type: "pie",
        data: {
          labels: ["Deposit", "Withdraw"],
          datasets: [
            {
              label: "Categories",
              data: [transactionCategories.Deposit, transactionCategories.Withdraw],
              borderWidth: 1,
            },
          ],
        },
        options: {
          scales: {
            y: {
              beginAtZero: true,
            },
          },
        },
      });
      
      $("periodDays").addEventListener("change", (ev) => {
        const periodDays = $("periodDays").value;
        window.location.href = `/home?periodDays=${periodDays}`;
      });
  </script>
  </body>
</html>
